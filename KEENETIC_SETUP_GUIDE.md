# Keenetic WireGuard Setup Guide

## Важно! О вашем списке маршрутов

У вас есть список из **1300+ маршрутов /24**, что является **избыточным и неэффективным** для роутера. 

### Проблемы с большим количеством маршрутов:
- ❌ Перегрузка процессора роутера
- ❌ Замедление работы сети
- ❌ Возможные зависания
- ❌ Долгое время применения настроек

### ✅ Рекомендуемое решение:
Используйте **агрегированные CIDR-блоки** вместо отдельных /24 сетей.

Например, вместо:
```
ip route 74.125.0.0/24 Wireguard0
ip route 74.125.1.0/24 Wireguard0
ip route 74.125.2.0/24 Wireguard0
...
ip route 74.125.255.0/24 Wireguard0
```

Используйте:
```
ip route 74.125.0.0/16 Wireguard0
```

---

## Шаг 1: Включение SSH на роутере

### Через веб-интерфейс Keenetic:

1. **Управление → Общие настройки → Изменить набор компонентов**
   - Найдите и установите компонент **"Протокол SSH"**
   - Нажмите "Установить" и дождитесь перезагрузки

2. **Управление → Система → Пользователи**
   - Убедитесь, что для пользователя `admin` включен доступ по SSH
   - Если нет, включите галочку "Доступ по SSH"

3. **Безопасность → Межсетевой экран → Добавить правило**
   - Создайте правило для разрешения SSH (порт 22)
   - Источник: ваш IP-адрес (83.217.9.75) или "Любой" (менее безопасно)
   - Назначение: роутер
   - Протокол: TCP
   - Порт: 22
   - Действие: Разрешить

---

## Шаг 2: Настройка WireGuard через веб-интерфейс

Перед настройкой маршрутов нужно создать WireGuard интерфейс:

1. **Интернет → Другие подключения → Добавить подключение**
2. Выберите **WireGuard**
3. Заполните поля:
   - **Описание**: VPN (или любое имя)
   - **Приватный ключ**: ваш PrivateKey
   - **IP-адрес**: ваш Address (например, 10.0.0.2/32)
   - **MTU**: 1420

4. **Добавить peer (сервер)**:
   - **Публичный ключ**: PublicKey сервера
   - **Предварительный общий ключ**: ваш PresharedKey (если есть)
   - **Endpoint**: адрес:порт сервера (например, vpn.example.com:51820)
   - **Allowed IPs**: 0.0.0.0/0, ::/0
   - **Persistent keepalive**: 25

5. Нажмите **Сохранить**

---

## Шаг 3: Применение маршрутов через SSH

### Вариант A: Автоматическое применение (рекомендуется)

Используйте подготовленный скрипт с оптимизированными маршрутами:

```bash
cd /Users/agdelesha/Desktop/myScripts/wgScript
chmod +x apply-routes.sh
./apply-routes.sh ROUTER_IP admin
```

Замените `ROUTER_IP` на внешний IP или домен вашего роутера.

### Вариант B: Ручное применение через SSH

```bash
# Подключитесь к роутеру
ssh admin@ROUTER_IP

# Войдите в режим конфигурации
configure

# Добавьте маршруты для YouTube (Google)
ip route 74.125.0.0/16 Wireguard0
ip route 142.250.0.0/15 Wireguard0
ip route 172.217.0.0/16 Wireguard0
ip route 173.194.0.0/16 Wireguard0
ip route 216.58.192.0/19 Wireguard0
ip route 209.85.128.0/17 Wireguard0

# Добавьте маршруты для Instagram/Facebook
ip route 31.13.24.0/21 Wireguard0
ip route 31.13.64.0/18 Wireguard0
ip route 157.240.0.0/16 Wireguard0

# Добавьте маршруты для OpenAI
ip route 104.18.0.0/20 Wireguard0
ip route 172.64.0.0/13 Wireguard0
ip route 104.16.0.0/13 Wireguard0

# Сохраните конфигурацию
system configuration save

# Выйдите
exit
```

---

## Шаг 4: Проверка работы

### Проверка маршрутов:

```bash
ssh admin@ROUTER_IP 'show ip route'
```

### Проверка WireGuard:

```bash
ssh admin@ROUTER_IP 'show interface Wireguard0'
ssh admin@ROUTER_IP 'show interface Wireguard0 peer'
```

### Проверка с устройства в сети:

```bash
# Проверить обычный IP (должен быть ваш реальный IP)
curl https://api.ipify.org

# Проверить через какой IP идет YouTube
# (если через VPN, покажет IP VPN-сервера)
nslookup youtube.com
```

---

## Альтернатива: Настройка через веб-интерфейс

Если SSH не работает или вы предпочитаете веб-интерфейс:

1. **Интернет → Маршруты → Добавить маршрут**
2. Для каждого IP-диапазона создайте маршрут:
   - **Сеть назначения**: например, 74.125.0.0
   - **Маска**: 255.255.0.0 (для /16)
   - **Шлюз**: выберите интерфейс **Wireguard0**
   - **Метрика**: оставьте по умолчанию

### Основные маршруты для добавления:

**YouTube/Google:**
- 74.125.0.0/16
- 142.250.0.0/15
- 172.217.0.0/16
- 173.194.0.0/16
- 216.58.192.0/19
- 209.85.128.0/17

**Instagram/Facebook:**
- 31.13.24.0/21
- 31.13.64.0/18
- 157.240.0.0/16

**OpenAI:**
- 104.18.0.0/20
- 172.64.0.0/13
- 104.16.0.0/13

---

## Troubleshooting

### Проблема: Маршруты не применяются

**Решение:**
1. Убедитесь, что WireGuard интерфейс создан и активен
2. Проверьте, что интерфейс называется именно `Wireguard0`
3. Проверьте статус: `show interface Wireguard0`

### Проблема: Сайты не открываются через VPN

**Решение:**
1. Проверьте, что VPN-соединение активно: `show interface Wireguard0 peer`
2. Проверьте DNS-настройки
3. Попробуйте ping через интерфейс: `ping -I Wireguard0 8.8.8.8`

### Проблема: Роутер тормозит после добавления маршрутов

**Решение:**
1. Удалите все маршруты: `no ip route 0.0.0.0/0 Wireguard0`
2. Используйте только агрегированные блоки (не добавляйте 1300+ маршрутов!)
3. Рассмотрите использование policy-based routing вместо статических маршрутов

---

## Дополнительные рекомендации

### 1. Обновление IP-адресов

IP-адреса сервисов могут меняться. Для автоматического обновления:

```bash
# Получить актуальные IP YouTube
nslookup youtube.com
nslookup googlevideo.com

# Получить актуальные IP Instagram
nslookup instagram.com
nslookup cdninstagram.com

# Получить актуальные IP OpenAI
nslookup chat.openai.com
nslookup api.openai.com
```

### 2. DNS-based routing (альтернатива)

Вместо статических маршрутов можно использовать DNS-based routing с dnsmasq:
- Более гибко
- Автоматически обновляется
- Меньше нагрузка на роутер

### 3. Мониторинг

Следите за нагрузкой на роутер:
```bash
ssh admin@ROUTER_IP 'show system resources'
```

---

## Контакты и поддержка

Если возникли проблемы:
1. Проверьте логи роутера: `show log`
2. Проверьте документацию Keenetic: https://help.keenetic.com
3. Убедитесь, что версия прошивки актуальная
